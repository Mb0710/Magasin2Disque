<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="page-title">Cr√©er un disque - Magasin2Disque</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }
        nav {
            background: rgba(255, 255, 255, 0.95);
            padding: 15px 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        nav h1 { color: #667eea; font-size: 24px; }
        .nav-right { display:flex; gap:12px; align-items:center; }
        .btn { padding:10px 16px; border:none; border-radius:8px; cursor:pointer; font-weight:600; }
        .btn-primary { background:#667eea; color:white; }
        .container { max-width:900px; margin:40px auto; padding:0 20px; }
        .card { background: white; padding: 30px; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.15); }
        h2 { color:#333; margin-bottom:10px; }
        form { display: grid; grid-template-columns: 1fr 1fr; gap:16px; }
        .full { grid-column: 1/-1; }
        label { display:block; margin-bottom:6px; color:#555; font-weight:600; }
        input[type="text"], input[type="number"], input[type="url"], textarea, select {
            width:100%; padding:10px 12px; border:2px solid #e6e6e6; border-radius:8px; font-size:14px;
        }
        textarea { resize: vertical; min-height:100px; }
        .actions { display:flex; gap:12px; justify-content:flex-end; margin-top:8px; }
        .message { padding:12px; border-radius:8px; margin-top:12px; display:none; }
        .error { background:#fadbd8; color:#8b1c1c; }
        .success { background:#d5f4e6; color:#1f7a4d; }
        @media (max-width:700px) { form { grid-template-columns: 1fr; } }
    </style>
</head>
<body>
    <nav>
        <h1>üéµ Magasin2Disque</h1>
        <div class="nav-right">
            <a class="btn btn-primary" href="/index.html">Retour</a>
        </div>
    </nav>

    <div class="container">
        <div class="card">
            <h2 id="form-title">Cr√©er un nouveau disque</h2>
            <p id="form-desc" style="color:#666; margin-bottom:18px;">Remplissez le formulaire pour ajouter un disque √† votre catalogue.</p>

            <form id="disque-form">
                <div>
                    <label for="titre">Titre *</label>
                    <input type="text" id="titre" name="titre" required maxlength="200" />
                </div>

                <div>
                    <label for="artiste">Artiste *</label>
                    <input type="text" id="artiste" name="artiste" required maxlength="100" />
                </div>

                <div>
                    <label for="genre">Genre</label>
                    <input type="text" id="genre" name="genre" maxlength="50" />
                </div>

                <div>
                    <label for="annee">Ann√©e de sortie</label>
                    <input type="number" id="annee" name="annee" min="1900" max="2100" />
                </div>

                <div>
                    <label for="prix">Prix (‚Ç¨) *</label>
                    <input type="number" id="prix" name="prix" step="0.01" min="0" required />
                </div>

                <div>
                    <label for="stock">Stock *</label>
                    <input type="number" id="stock" name="stock" min="0" value="1" required />
                </div>

                <div class="full">
                    <label for="description">Description</label>
                    <textarea id="description" name="description" maxlength="500"></textarea>
                </div>

                <div>
                    <label for="imageUrl">Image URL</label>
                    <input type="url" id="imageUrl" name="imageUrl" />
                </div>

                <div>
                    <label for="etat">√âtat</label>
                    <select id="etat" name="etat">
                        <option value="NEUF">NEUF</option>
                        <option value="OCCASION">OCCASION</option>
                        <option value="COLLECTOR">COLLECTOR</option>
                    </select>
                </div>

                <div class="full actions">
                    <div style="flex:1"></div>
                    <button type="button" class="btn" id="cancel">Annuler</button>
                    <button type="submit" class="btn btn-primary" id="submit-btn">Cr√©er</button>
                </div>
            </form>

            <div id="error" class="message error"></div>
            <div id="success" class="message success"></div>
        </div>
    </div>

    <script>
        function qs(param) { return new URLSearchParams(window.location.search).get(param); }
        
        const form = document.getElementById('disque-form');
        const errorBox = document.getElementById('error');
        const successBox = document.getElementById('success');
        const cancelBtn = document.getElementById('cancel');
        const submitBtn = document.getElementById('submit-btn');
        const formTitle = document.getElementById('form-title');
        const formDesc = document.getElementById('form-desc');
        const pageTitle = document.getElementById('page-title');

        let editId = null; // ID du disque en √©dition (null si cr√©ation)

        cancelBtn.addEventListener('click', () => window.location.href = '/index.html');

        function showError(msg) {
            successBox.style.display = 'none';
            errorBox.textContent = msg;
            errorBox.style.display = 'block';
        }

        function showSuccess(msg) {
            errorBox.style.display = 'none';
            successBox.textContent = msg;
            successBox.style.display = 'block';
        }

        // Charger le disque si √©dition
        async function loadDisqueForEdit(id) {
            try {
                const res = await fetch('/api/disques/' + encodeURIComponent(id));
                if (!res.ok) throw new Error('Disque non trouv√©');
                const d = await res.json();

                // Pr√©-remplir le formulaire
                document.getElementById('titre').value = d.titre || '';
                document.getElementById('artiste').value = d.artiste || '';
                document.getElementById('genre').value = d.genre || '';
                document.getElementById('annee').value = d.anneeSortie || '';
                document.getElementById('prix').value = d.prix || '';
                document.getElementById('stock').value = d.stock || '';
                document.getElementById('description').value = d.description || '';
                document.getElementById('imageUrl').value = d.imageUrl || '';
                document.getElementById('etat').value = d.etat || 'NEUF';

                // Adapter l'affichage
                editId = id;
                pageTitle.textContent = '√âditer un disque - Magasin2Disque';
                formTitle.textContent = '√âditer le disque';
                formDesc.textContent = 'Modifiez les informations du disque et enregistrez vos modifications.';
                submitBtn.textContent = 'Enregistrer';

            } catch (err) {
                console.error('Erreur chargement disque:', err);
                showError('Impossible de charger le disque √† √©diter.');
            }
        }

        form.addEventListener('submit', async (e) => {
            e.preventDefault();

            const userId = localStorage.getItem('userId');
            if (!userId) {
                showError('Vous devez √™tre connect√©.');
                setTimeout(() => window.location.href = '/login.html', 1200);
                return;
            }

            const payload = {
                titre: document.getElementById('titre').value.trim(),
                artiste: document.getElementById('artiste').value.trim(),
                genre: document.getElementById('genre').value.trim() || null,
                anneeSortie: document.getElementById('annee').value ? Number(document.getElementById('annee').value) : null,
                prix: document.getElementById('prix').value ? Number(document.getElementById('prix').value) : 0,
                stock: document.getElementById('stock').value ? Number(document.getElementById('stock').value) : 0,
                description: document.getElementById('description').value.trim() || null,
                imageUrl: document.getElementById('imageUrl').value.trim() || null,
                etat: document.getElementById('etat').value || 'NEUF'
            };

            // Pour cr√©ation, ajouter vendeurId et disponible
            if (!editId) {
                payload.vendeurId = Number(userId);
                payload.disponible = true;
            }

            console.log('Payload:', payload);

            try {
                const method = editId ? 'PUT' : 'POST';
                const endpoint = editId ? `/api/disques/${editId}` : '/api/disques';
                
                const res = await fetch(endpoint, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const data = await res.json();

                if (res.ok) {
                    const msg = editId ? 'Disque modifi√© avec succ√®s' : 'Disque cr√©√© avec succ√®s';
                    showSuccess(msg + '. Redirection...');
                    setTimeout(() => window.location.href = '/index.html', 1100);
                } else {
                    showError(data.error || (data.message || 'Erreur lors de l\'op√©ration'));
                }
            } catch (err) {
                console.error(err);
                showError('Erreur r√©seau ou serveur. V√©rifiez que l\'application est d√©marr√©e.');
            }
        });

        // D√©terminer si √©dition ou cr√©ation au chargement
        (function() {
            const edit = qs('edit');
            if (edit) {
                loadDisqueForEdit(edit);
            }
        })();
    </script>
</body>
</html>
<!DOCTYPE html>