<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>D√©tails de l'annonce - Magasin2Disque</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        nav {
            background: rgba(255, 255, 255, 0.95);
            padding: 15px 30px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        nav h1 {
            color: #667eea;
            font-size: 24px;
        }

        .container {
            max-width: 900px;
            margin: 40px auto;
            padding: 0 20px;
        }

        .back-btn {
            display: inline-block;
            color: white;
            text-decoration: none;
            font-weight: 600;
            margin-bottom: 20px;
            padding: 10px 20px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            transition: all 0.3s;
        }

        .back-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .annonce-detail {
            background: white;
            border-radius: 15px;
            padding: 40px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        .annonce-header {
            border-bottom: 2px solid #e0e0e0;
            padding-bottom: 20px;
            margin-bottom: 20px;
        }

        .annonce-header h2 {
            color: #333;
            font-size: 32px;
            margin-bottom: 10px;
        }

        .annonce-header .artiste {
            color: #666;
            font-size: 20px;
            font-style: italic;
        }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin-bottom: 30px;
        }

        .info-item {
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .info-item label {
            display: block;
            color: #666;
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .info-item .value {
            color: #333;
            font-size: 18px;
            font-weight: 500;
        }

        .price-section {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            margin-bottom: 20px;
        }

        .price-section .label {
            font-size: 14px;
            margin-bottom: 5px;
        }

        .price-section .price {
            font-size: 48px;
            font-weight: 700;
        }

        .description {
            margin-top: 20px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .description h3 {
            color: #333;
            margin-bottom: 10px;
        }

        .description p {
            color: #666;
            line-height: 1.6;
        }

        .actions {
            display: flex;
            gap: 15px;
            margin-top: 30px;
        }

        .btn {
            flex: 1;
            padding: 15px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #ffc107;
            color: #333;
        }

        .btn-secondary:hover {
            background: #ffb300;
        }

        .error {
            color: #e74c3c;
            background: #fadbd8;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            margin: 20px 0;
        }

        .success {
            color: #27ae60;
            background: #d5f4e6;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            margin: 20px 0;
            display: none;
        }
    </style>
</head>

<body>
    <nav>
        <h1>üéµ Magasin2Disque</h1>
    </nav>

    <div class="container">
        <a href="/index.html" class="back-btn">‚Üê Retour aux annonces</a>

        <div id="content">
            <div style="color: white; text-align: center; padding: 40px;">
                Chargement...
            </div>
        </div>
    </div>

    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const annonceId = urlParams.get('id');
        const userId = localStorage.getItem('userId');

        if (!userId) {
            window.location.href = '/login.html';
        }

        async function loadAnnonce() {
            if (!annonceId) {
                document.getElementById('content').innerHTML =
                    '<div class="error">Aucune annonce sp√©cifi√©e</div>';
                return;
            }

            try {
                const response = await fetch(`/api/annonces/${annonceId}`);
                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'Annonce non trouv√©e');
                }

                const annonce = data.annonce || data;
                const isOwner = annonce.vendeurId == userId;

                document.getElementById('content').innerHTML = `
                    <div class="annonce-detail">
                        ${annonce.imageUrl ? `
                            <div style="text-align: center; margin-bottom: 20px;">
                                <img src="${annonce.imageUrl}" alt="${annonce.titre}" 
                                     style="max-width: 100%; max-height: 400px; border-radius: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.2);">
                            </div>
                        ` : ''}
                        <div class="annonce-header">
                            <h2>${annonce.titre}</h2>
                            <div class="artiste">${annonce.artiste}</div>
                        </div>

                        <div class="price-section">
                            <div class="label">Prix</div>
                            <div class="price">${annonce.prix.toFixed(2)} ‚Ç¨</div>
                        </div>

                        <div class="info-grid">
                            <div class="info-item">
                                <label>Genre</label>
                                <div class="value">${annonce.genre || 'Non sp√©cifi√©'}</div>
                            </div>
                            <div class="info-item">
                                <label>√âtat</label>
                                <div class="value">${annonce.etat}</div>
                            </div>
                            <div class="info-item">
                                <label>Vendeur</label>
                                <div class="value">
                                    <a href="/profil.html?id=${annonce.vendeurId}" style="color: #667eea; text-decoration: none; font-weight: 600;">
                                        üë§ ${annonce.vendeurUsername || 'Inconnu'}
                                    </a>
                                </div>
                            </div>
                            <div class="info-item">
                                <label>Disponibilit√©</label>
                                <div class="value">${annonce.disponible ? '‚úÖ Disponible' : '‚ùå Vendu'}</div>
                            </div>
                        </div>

                        ${annonce.description ? `
                            <div class="description">
                                <h3>Description</h3>
                                <p>${annonce.description}</p>
                            </div>
                        ` : ''}

                        ${!isOwner && annonce.disponible ? `
                            <div class="actions">
                                <button class="btn btn-primary" onclick="acheterDirect()">
                                    üí≥ Acheter maintenant
                                </button>
                                <button class="btn btn-secondary" onclick="faireOffre()">
                                    üíº Faire une offre
                                </button>
                                <button class="btn" style="background: #4CAF50; color: white;" 
                                        onclick="contacterVendeur(${annonce.vendeurId})">
                                    üí¨ Contacter le vendeur
                                </button>
                            </div>
                            <div class="success" id="success-msg"></div>
                            <div class="error" id="error-msg" style="display: none;"></div>
                        ` : isOwner ? `
                            <div style="text-align: center; padding: 20px;">
                                <p style="color: #666; margin-bottom: 20px;">C'est votre annonce</p>
                                <div style="display: flex; gap: 15px; max-width: 600px; margin: 0 auto;">
                                    <button class="btn" style="background: #667eea; flex: 1;" 
                                            onclick="modifierAnnonce()">
                                        ‚úèÔ∏è Modifier l'annonce
                                    </button>
                                    <button class="btn" style="background: #e74c3c; flex: 1;" 
                                            onclick="supprimerAnnonce()">
                                        üóëÔ∏è Supprimer l'annonce
                                    </button>
                                </div>
                            </div>
                        ` : `
                            <div class="error">Annonce non disponible</div>
                        `}
                    </div>
                `;

            } catch (error) {
                console.error('Erreur:', error);
                document.getElementById('content').innerHTML =
                    `<div class="error">${error.message}</div>`;
            }
        }

        async function acheterDirect() {
            const errorMsg = document.getElementById('error-msg');
            const successMsg = document.getElementById('success-msg');

            errorMsg.style.display = 'none';
            successMsg.style.display = 'none';

            try {
                const response = await fetch('http://localhost:8080/api/transactions/acheter', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        annonceId: parseInt(annonceId),
                        acheteurId: parseInt(userId)
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    successMsg.textContent = 'Achat effectu√© avec succ√®s ! Le vendeur a √©t√© notifi√©.';
                    successMsg.style.display = 'block';
                    setTimeout(() => window.location.href = '/index.html', 2000);
                } else {
                    errorMsg.textContent = data.error || 'Erreur lors de l\'achat';
                    errorMsg.style.display = 'block';
                }
            } catch (error) {
                errorMsg.textContent = 'Erreur serveur';
                errorMsg.style.display = 'block';
            }
        }

        function modifierAnnonce() {
            window.location.href = `/edit-annonce.html?id=${annonceId}`;
        }

        async function supprimerAnnonce() {
            if (!confirm('√ätes-vous s√ªr de vouloir supprimer cette annonce ?')) {
                return;
            }

            try {
                const response = await fetch(`/api/annonces/${annonceId}`, {
                    method: 'DELETE'
                });

                const data = await response.json();

                if (response.ok) {
                    alert('Annonce supprim√©e avec succ√®s');
                    window.location.href = '/index.html';
                } else {
                    alert(data.error || 'Erreur lors de la suppression');
                }
            } catch (error) {
                alert('Erreur serveur');
            }
        }

        async function faireOffre() {
            const prix = prompt('Entrez votre prix propos√© (‚Ç¨):');
            if (!prix) return;

            const message = prompt('Message au vendeur (optionnel):');

            const errorMsg = document.getElementById('error-msg');
            const successMsg = document.getElementById('success-msg');

            errorMsg.style.display = 'none';
            successMsg.style.display = 'none';

            try {
                const response = await fetch('http://localhost:8080/api/offres', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        annonceId: parseInt(annonceId),
                        acheteurId: parseInt(userId),
                        prixPropose: parseFloat(prix),
                        message: message || ''
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    successMsg.textContent = 'Offre envoy√©e avec succ√®s ! Le vendeur va l\'examiner.';
                    successMsg.style.display = 'block';
                } else {
                    errorMsg.textContent = data.error || 'Erreur lors de l\'envoi de l\'offre';
                    errorMsg.style.display = 'block';
                }
            } catch (error) {
                errorMsg.textContent = 'Erreur serveur';
                errorMsg.style.display = 'block';
            }
        }

        // Fonction pour contacter le vendeur via messagerie
        async function contacterVendeur(vendeurId) {
            // Cr√©er ou trouver la conversation avec le vendeur
            try {
                // Rediriger vers la messagerie avec l'ID du vendeur
                window.location.href = `/messages.html?userId=${vendeurId}`;
            } catch (error) {
                alert('Erreur lors de l\'ouverture de la messagerie');
            }
        }

        loadAnnonce();
    </script>
</body>

</html>