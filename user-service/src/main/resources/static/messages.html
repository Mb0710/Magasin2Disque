<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Messagerie - Magasin 2 Disque</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            overflow: hidden;
            height: 80vh;
            display: flex;
        }

        .navbar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: rgba(255,255,255,0.95);
            padding: 15px 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            z-index: 1000;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .navbar h1 {
            color: #667eea;
            font-size: 1.5rem;
        }

        .navbar-links {
            display: flex;
            gap: 20px;
        }

        .navbar-links a {
            color: #333;
            text-decoration: none;
            padding: 8px 15px;
            border-radius: 5px;
            transition: background 0.3s;
        }

        .navbar-links a:hover {
            background: #f0f0f0;
        }

        .conversations-list {
            width: 350px;
            border-right: 1px solid #e0e0e0;
            background: #f9f9f9;
            overflow-y: auto;
        }

        .conversations-header {
            padding: 20px;
            background: #667eea;
            color: white;
        }

        .conversations-header h2 {
            font-size: 1.3rem;
        }

        .conversation-item {
            padding: 15px 20px;
            border-bottom: 1px solid #e0e0e0;
            cursor: pointer;
            transition: background 0.2s;
            display: flex;
            justify-content: space-between;
            align-items: start;
        }

        .conversation-item:hover {
            background: #f0f0f0;
        }

        .conversation-item.active {
            background: #e8eaf6;
            border-left: 4px solid #667eea;
        }

        .conversation-info {
            flex: 1;
        }

        .conversation-username {
            font-weight: bold;
            color: #333;
            margin-bottom: 5px;
        }

        .conversation-last-message {
            color: #666;
            font-size: 0.9rem;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .unread-badge {
            background: #ff5252;
            color: white;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: bold;
        }

        .chat-area {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .chat-header {
            padding: 20px;
            background: #667eea;
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chat-header h3 {
            font-size: 1.2rem;
        }

        .messages-container {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            background: #fafafa;
        }

        .message {
            margin-bottom: 15px;
            display: flex;
            flex-direction: column;
        }

        .message.sent {
            align-items: flex-end;
        }

        .message.received {
            align-items: flex-start;
        }

        .message-content {
            max-width: 60%;
            padding: 12px 16px;
            border-radius: 12px;
            word-wrap: break-word;
        }
        
        .message-attachment {
            margin-top: 8px;
            padding: 10px;
            background: rgba(0,0,0,0.05);
            border-radius: 8px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .message.sent .message-attachment {
            background: rgba(255,255,255,0.2);
        }
        
        .attachment-icon {
            font-size: 1.5rem;
        }
        
        .attachment-info {
            flex: 1;
            overflow: hidden;
        }
        
        .attachment-name {
            font-weight: bold;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .attachment-image {
            max-width: 100%;
            max-height: 300px;
            border-radius: 8px;
            margin-top: 8px;
            cursor: pointer;
        }
        
        .attachment-download {
            color: #667eea;
            text-decoration: none;
            font-size: 0.9rem;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }
        
        .message.sent .attachment-download {
            color: white;
        }

        .message.sent .message-content {
            background: #667eea;
            color: white;
            border-bottom-right-radius: 4px;
        }

        .message.received .message-content {
            background: white;
            color: #333;
            border-bottom-left-radius: 4px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .message-time {
            font-size: 0.75rem;
            color: #999;
            margin-top: 4px;
        }

        .message-input-area {
            padding: 20px;
            background: white;
            border-top: 1px solid #e0e0e0;
            display: flex;
            gap: 10px;
        }

        .message-input {
            flex: 1;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 25px;
            font-size: 1rem;
            outline: none;
            transition: border-color 0.3s;
        }

        .message-input:focus {
            border-color: #667eea;
        }

        .send-button {
            padding: 12px 30px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 25px;
            font-size: 1rem;
            cursor: pointer;
            transition: background 0.3s;
        }

        .send-button:hover {
            background: #5568d3;
        }

        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #999;
        }

        .empty-state i {
            font-size: 4rem;
            margin-bottom: 20px;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #999;
        }

        .error {
            background: #ff5252;
            color: white;
            padding: 10px;
            margin: 10px;
            border-radius: 5px;
        }
        
        .file-input-wrapper {
            position: relative;
            display: inline-block;
        }
        
        .file-input-button {
            background: #f0f0f0;
            border: 2px solid #e0e0e0;
            border-radius: 50%;
            width: 45px;
            height: 45px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .file-input-button:hover {
            background: #e0e0e0;
            border-color: #667eea;
        }
        
        .file-input-button input {
            position: absolute;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }
        
        .file-preview {
            display: none;
            padding: 10px;
            background: #f9f9f9;
            border: 2px dashed #667eea;
            border-radius: 8px;
            margin-bottom: 10px;
            align-items: center;
            gap: 10px;
        }
        
        .file-preview.active {
            display: flex;
        }
        
        .file-preview-info {
            flex: 1;
            overflow: hidden;
        }
        
        .file-preview-name {
            font-weight: bold;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .file-preview-size {
            font-size: 0.85rem;
            color: #666;
        }
        
        .file-preview-remove {
            background: #ff5252;
            color: white;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            cursor: pointer;
            font-size: 1.2rem;
        }
    </style>
</head>
<body>
    <div class="navbar">
        <h1>üéµ Magasin 2 Disque</h1>
        <div class="navbar-links">
            <a href="index.html">Accueil</a>
            <a href="mes-annonces.html">Mes Annonces</a>
            <a href="messages.html">Messages</a>
            <a href="profil.html">Profil</a>
            <a href="#" onclick="logout()">D√©connexion</a>
        </div>
    </div>

    <div style="height: 70px;"></div>

    <div class="container">
        <!-- Liste des conversations -->
        <div class="conversations-list">
            <div class="conversations-header">
                <h2>Conversations</h2>
            </div>
            <div id="conversationsList">
                <div class="loading">Chargement des conversations...</div>
            </div>
        </div>

        <!-- Zone de chat -->
        <div class="chat-area">
            <div class="chat-header">
                <h3 id="chatUsername">S√©lectionnez une conversation</h3>
                <span id="unreadCount"></span>
            </div>
            
            <div class="messages-container" id="messagesContainer">
                <div class="empty-state">
                    <i>üí¨</i>
                    <p>S√©lectionnez une conversation pour commencer √† discuter</p>
                </div>
            </div>

            <div class="file-preview" id="filePreview">
                <div class="file-preview-info">
                    <div class="file-preview-name" id="filePreviewName"></div>
                    <div class="file-preview-size" id="filePreviewSize"></div>
                </div>
                <button class="file-preview-remove" onclick="removeFile()">√ó</button>
            </div>

            <div class="message-input-area">
                <div class="file-input-wrapper">
                    <label class="file-input-button">
                        üìé
                        <input 
                            type="file" 
                            id="fileInput" 
                            onchange="handleFileSelect(event)"
                            accept="image/*,.pdf,.doc,.docx,.txt"
                        >
                    </label>
                </div>
                <input 
                    type="text" 
                    class="message-input" 
                    id="messageInput" 
                    placeholder="√âcrivez votre message..."
                    disabled
                >
                <button class="send-button" id="sendButton" onclick="sendMessage()" disabled>
                    Envoyer
                </button>
            </div>
        </div>
    </div>

    <script>
        const API_URL = 'http://localhost:8081/api';
        let currentConversationId = null;
        let currentUserId = null;
        let conversations = [];
        let selectedFile = null;

        // R√©cup√©rer l'ID utilisateur depuis l'URL (pour initier une conversation)
        const urlParams = new URLSearchParams(window.location.search);
        const targetUserId = urlParams.get('userId');

        // V√©rifier si l'utilisateur est connect√©
        function checkAuth() {
            const token = localStorage.getItem('token');
            if (!token) {
                window.location.href = 'login.html';
                return false;
            }
            return true;
        }

        // Obtenir les headers avec le token
        function getAuthHeaders() {
            return {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${localStorage.getItem('token')}`
            };
        }

        // Charger les conversations
        async function loadConversations() {
            try {
                const response = await fetch(`${API_URL}/messages/conversations`, {
                    headers: getAuthHeaders()
                });

                if (!response.ok) throw new Error('Erreur de chargement');

                conversations = await response.json();
                displayConversations(conversations);
            } catch (error) {
                console.error('Erreur:', error);
                document.getElementById('conversationsList').innerHTML = 
                    '<div class="error">Erreur de chargement des conversations</div>';
            }
        }

        // Afficher les conversations
        function displayConversations(conversations) {
            const container = document.getElementById('conversationsList');
            
            if (conversations.length === 0) {
                container.innerHTML = '<div class="loading">Aucune conversation</div>';
                return;
            }

            container.innerHTML = conversations.map(conv => `
                <div class="conversation-item" onclick="selectConversation(${conv.id}, '${conv.otherUsername}')">
                    <div class="conversation-info">
                        <div class="conversation-username">${conv.otherUsername}</div>
                        <div class="conversation-last-message">${conv.lastMessage || 'Aucun message'}</div>
                    </div>
                    ${conv.unreadCount > 0 ? `<span class="unread-badge">${conv.unreadCount}</span>` : ''}
                </div>
            `).join('');
        }

        // S√©lectionner une conversation
        async function selectConversation(conversationId, username) {
            currentConversationId = conversationId;
            
            // Mettre √† jour l'interface
            document.getElementById('chatUsername').textContent = username;
            document.getElementById('messageInput').disabled = false;
            document.getElementById('sendButton').disabled = false;

            // Marquer comme active
            document.querySelectorAll('.conversation-item').forEach(item => {
                item.classList.remove('active');
            });
            event.currentTarget.classList.add('active');

            // Charger les messages
            await loadMessages(conversationId);
            
            // Marquer comme lu
            await markAsRead(conversationId);
        }

        // Charger les messages d'une conversation
        async function loadMessages(conversationId) {
            try {
                const response = await fetch(`${API_URL}/messages/conversation/${conversationId}`, {
                    headers: getAuthHeaders()
                });

                if (!response.ok) throw new Error('Erreur de chargement');

                const messages = await response.json();
                displayMessages(messages);
            } catch (error) {
                console.error('Erreur:', error);
                document.getElementById('messagesContainer').innerHTML = 
                    '<div class="error">Erreur de chargement des messages</div>';
            }
        }

        // Afficher les messages
        function displayMessages(messages) {
            const container = document.getElementById('messagesContainer');
            
            if (messages.length === 0) {
                container.innerHTML = '<div class="empty-state"><p>Aucun message. Commencez la conversation !</p></div>';
                return;
            }

            // Obtenir l'ID de l'utilisateur connect√©
            const token = localStorage.getItem('token');
            const payload = JSON.parse(atob(token.split('.')[1]));
            currentUserId = payload.userId || payload.sub;

            container.innerHTML = messages.map(msg => {
                const isSent = msg.senderId == currentUserId;
                const date = new Date(msg.sentAt);
                const timeStr = date.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });

                let attachmentHtml = '';
                if (msg.attachmentUrl) {
                    const isImage = msg.attachmentType && msg.attachmentType.startsWith('image/');
                    
                    if (isImage) {
                        attachmentHtml = `
                            <div class="message-attachment">
                                <img src="${msg.attachmentUrl}" class="attachment-image" 
                                     alt="${msg.attachmentName}" 
                                     onclick="window.open('${msg.attachmentUrl}', '_blank')">
                            </div>
                        `;
                    } else {
                        attachmentHtml = `
                            <div class="message-attachment">
                                <span class="attachment-icon">üìÑ</span>
                                <div class="attachment-info">
                                    <div class="attachment-name">${msg.attachmentName}</div>
                                    <a href="${msg.attachmentUrl}" download="${msg.attachmentName}" 
                                       class="attachment-download">
                                        ‚¨áÔ∏è T√©l√©charger
                                    </a>
                                </div>
                            </div>
                        `;
                    }
                }

                return `
                    <div class="message ${isSent ? 'sent' : 'received'}">
                        <div class="message-content">
                            ${msg.content}
                            ${attachmentHtml}
                        </div>
                        <div class="message-time">${timeStr}</div>
                    </div>
                `;
            }).join('');

            // Scroller vers le bas
            container.scrollTop = container.scrollHeight;
        }

        // Envoyer un message
        async function sendMessage() {
            const input = document.getElementById('messageInput');
            const content = input.value.trim();

            if (!content && !selectedFile) return;

            // D√©terminer le receiverId
            let receiverId;
            if (currentConversationId) {
                // Conversation existante
                const conv = conversations.find(c => c.id === currentConversationId);
                if (!conv) return;
                receiverId = conv.otherUserId;
            } else if (window.tempReceiverId) {
                // Nouvelle conversation initi√©e depuis un profil/annonce
                receiverId = window.tempReceiverId;
            } else {
                return;
            }

            try {
                let response;
                
                // Si un fichier est s√©lectionn√©, envoyer avec pi√®ce jointe
                if (selectedFile) {
                    const formData = new FormData();
                    formData.append('receiverId', receiverId);
                    formData.append('content', content || 'üìé Pi√®ce jointe');
                    formData.append('file', selectedFile);

                    response = await fetch(`${API_URL}/messages/send-with-attachment`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${localStorage.getItem('token')}`
                        },
                        body: formData
                    });
                } else {
                    // Envoyer un message texte simple
                    response = await fetch(`${API_URL}/messages/send`, {
                        method: 'POST',
                        headers: getAuthHeaders(),
                        body: JSON.stringify({
                            receiverId: receiverId,
                            content: content
                        })
                    });
                }

                if (!response.ok) throw new Error('Erreur d\'envoi');

                // Si c'√©tait une nouvelle conversation, recharger la liste
                if (!currentConversationId) {
                    await loadConversations();
                    // Trouver et s√©lectionner la nouvelle conversation
                    const newConv = conversations.find(c => c.otherUserId == receiverId);
                    if (newConv) {
                        currentConversationId = newConv.id;
                        delete window.tempReceiverId;
                    }
                }

                // Recharger les messages
                if (currentConversationId) {
                    await loadMessages(currentConversationId);
                }
                await loadConversations();

                // Vider l'input et supprimer le fichier
                input.value = '';
                removeFile();
            } catch (error) {
                console.error('Erreur:', error);
                alert('Erreur lors de l\'envoi du message');
            }
        }
        
        // G√©rer la s√©lection de fichier
        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            // V√©rifier la taille du fichier (max 10MB)
            if (file.size > 10 * 1024 * 1024) {
                alert('Le fichier est trop volumineux. Maximum 10MB.');
                return;
            }
            
            selectedFile = file;
            
            // Afficher l'aper√ßu
            const preview = document.getElementById('filePreview');
            const fileName = document.getElementById('filePreviewName');
            const fileSize = document.getElementById('filePreviewSize');
            
            fileName.textContent = file.name;
            fileSize.textContent = formatFileSize(file.size);
            preview.classList.add('active');
        }
        
        // Supprimer le fichier s√©lectionn√©
        function removeFile() {
            selectedFile = null;
            document.getElementById('fileInput').value = '';
            document.getElementById('filePreview').classList.remove('active');
        }
        
        // Formater la taille du fichier
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
        }

        // Marquer une conversation comme lue
        async function markAsRead(conversationId) {
            try {
                await fetch(`${API_URL}/messages/conversation/${conversationId}/read`, {
                    method: 'PUT',
                    headers: getAuthHeaders()
                });
                await loadConversations();
            } catch (error) {
                console.error('Erreur:', error);
            }
        }

        // Envoyer avec Enter
        document.addEventListener('DOMContentLoaded', () => {
            const input = document.getElementById('messageInput');
            input.addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && !input.disabled) {
                    sendMessage();
                }
            });
        });

        // D√©connexion
        function logout() {
            localStorage.removeItem('token');
            window.location.href = 'login.html';
        }

        // Actualiser les conversations toutes les 10 secondes
        setInterval(() => {
            if (currentConversationId) {
                loadMessages(currentConversationId);
            }
            loadConversations();
        }, 10000);

        // Initialisation
        if (checkAuth()) {
            loadConversations().then(() => {
                // Si on a un userId dans l'URL, initier une conversation avec cet utilisateur
                if (targetUserId) {
                    initiateConversationWithUser(parseInt(targetUserId));
                }
            });
        }
        
        // Fonction pour initier une conversation avec un utilisateur
        async function initiateConversationWithUser(userId) {
            try {
                // Chercher si une conversation existe d√©j√† avec cet utilisateur
                const existingConv = conversations.find(c => c.otherUserId == userId);
                
                if (existingConv) {
                    // S√©lectionner la conversation existante
                    selectConversation(existingConv.id, existingConv.otherUsername);
                    // Mettre en surbrillance la conversation
                    const convElement = document.querySelector(`[onclick*="selectConversation(${existingConv.id}"]`);
                    if (convElement) {
                        convElement.classList.add('active');
                    }
                } else {
                    // Charger les infos de l'utilisateur cible
                    const response = await fetch(`${API_URL}/users/${userId}`);
                    if (!response.ok) throw new Error('Utilisateur non trouv√©');
                    
                    const user = await response.json();
                    
                    // Activer l'interface pour commencer une nouvelle conversation
                    currentConversationId = null; // Pas encore de conversation
                    document.getElementById('chatUsername').textContent = user.username;
                    document.getElementById('messageInput').disabled = false;
                    document.getElementById('sendButton').disabled = false;
                    
                    // Modifier temporairement la fonction sendMessage pour cr√©er la conversation
                    window.tempReceiverId = userId;
                    
                    // Afficher un message d'accueil
                    document.getElementById('messagesContainer').innerHTML = `
                        <div class="empty-state">
                            <i>üí¨</i>
                            <p>Commencez une conversation avec ${user.username}</p>
                        </div>
                    `;
                }
                
                // Nettoyer l'URL
                window.history.replaceState({}, document.title, '/messages.html');
            } catch (error) {
                console.error('Erreur:', error);
                alert('Impossible de d√©marrer la conversation');
            }
        }
    </script>
</body>
</html>
